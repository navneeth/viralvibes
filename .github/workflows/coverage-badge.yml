# ============================================================================
# .github/workflows/coverage-badge.yml
# SIMPLIFIED VERSION - Generates badge without artifact dependency
# ============================================================================

name: Coverage Badge & Report

on:
  # Trigger after CI workflow completes
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

permissions:
  contents: write
  pages: write

jobs:
  coverage:
    runs-on: ubuntu-latest

    # Only run on successful CI
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install coverage[toml] genbadge[coverage]

      # Try to download artifact, but don't fail if it doesn't exist
      - name: Download coverage artifact (if available)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: ./coverage-data

      # Fallback: Generate minimal coverage.xml if artifact not found
      - name: Create fallback coverage file
        run: |
          mkdir -p htmlcov

          # Check if coverage.xml exists
          if [ ! -f coverage-data/coverage.xml ] && [ ! -f coverage.xml ]; then
            echo "âš ï¸  No coverage.xml found, creating minimal fallback"
            cat > coverage.xml << 'EOF'
          <?xml version="1.0" ?>
          <coverage version="5.5" timestamp="0" lines-valid="0" lines-covered="0" line-rate="0" branches-covered="0" branch-rate="0" complexity="0">
            <sources>
              <source>.</source>
            </sources>
          </coverage>
          EOF
          else
            # Copy coverage.xml to root if it exists
            if [ -f coverage-data/coverage.xml ]; then
              cp coverage-data/coverage.xml ./coverage.xml
              echo "âœ… Using coverage.xml from artifact"
            fi

            # Copy htmlcov if it exists
            if [ -d coverage-data/htmlcov ]; then
              cp -r coverage-data/htmlcov/* ./htmlcov/ 2>/dev/null || true
              echo "âœ… Copied HTML report"
            fi
          fi

      # Generate badge
      - name: Generate coverage badge
        run: |
          genbadge coverage -i coverage.xml -o htmlcov/coverage-badge.svg 2>/dev/null || {
            echo "âš ï¸  Badge generation failed, using fallback"
            # Fallback: Create a minimal SVG badge
            mkdir -p htmlcov
            cat > htmlcov/coverage-badge.svg << 'SVG'
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="120" height="20" role="img" aria-label="coverage: unknown">
            <title>coverage: unknown</title>
            <linearGradient id="s" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb"/>
              <stop offset="1" stop-color="#999"/>
            </linearGradient>
            <clipPath id="r">
              <rect width="120" height="20" rx="3" fill="#fff"/>
            </clipPath>
            <g clip-path="url(#r)">
              <rect width="84" height="20" fill="#555"/>
              <rect x="84" width="36" height="20" fill="#9f9f9f"/>
              <rect width="120" height="20" fill="url(#s)" opacity=".1"/>
            </g>
            <g fill="#fff" text-anchor="middle" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" text-rendering="geometricPrecision" font-size="110">
              <text aria-hidden="true" x="430" y="150" fill="#010101" fill-opacity=".3" transform="scale(.1)" textLength="740">coverage</text>
              <text x="430" y="140" transform="scale(.1)" fill="#fff" textLength="740">coverage</text>
              <text aria-hidden="true" x="1010" y="150" fill="#010101" fill-opacity=".3" transform="scale(.1)" textLength="260">?</text>
              <text x="1010" y="140" transform="scale(.1)" fill="#fff" textLength="260">?</text>
            </g>
          </svg>
          SVG
          }

          echo "âœ… Badge ready at htmlcov/coverage-badge.svg"

      # Create landing page
      - name: Create landing page
        run: |
          cat > htmlcov/README.md << 'EOF'
          # ðŸ“Š ViralVibes - Test Coverage Report

          ![Coverage](./coverage-badge.svg)

          **Last Updated**: $(date -u +"%Y-%m-%d %H:%M UTC")

          ---

          ## ðŸ“ˆ Full Report

          [View detailed HTML coverage report â†’](./index.html)

          ## ðŸ“‹ Quick Links

          - [ðŸ  Repository](https://github.com/${{ github.repository }})
          - [ðŸ”„ CI Workflows](https://github.com/${{ github.repository }}/actions)

          ---

          *Generated by GitHub Actions*
          EOF

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./htmlcov
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸ“Š Coverage report updated'

      - name: âœ… Workflow complete
        run: |
          echo "Coverage badge workflow completed successfully!"
          echo "Report available at: https://github.com/${{ github.repository }}/deployments"
