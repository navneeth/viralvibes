# ============================================================================
# .github/workflows/coverage-badge.yml
# Production-ready coverage badge generation with proper error handling
# ============================================================================

name: Coverage Badge & Report

on:
  # Trigger after CI workflow completes
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: [completed]

permissions:
  contents: write
  pages: write

jobs:
  coverage:
    runs-on: ubuntu-latest

    # Only run on successful CI
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install coverage[toml] genbadge[coverage]

      # Download coverage artifact from CI workflow
      - name: Download coverage artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: ./coverage-data

      # Prepare coverage files
      - name: Prepare coverage files
        run: |
          mkdir -p htmlcov

          # Try to find and copy coverage.xml
          if [ -f coverage-data/coverage.xml ]; then
            cp coverage-data/coverage.xml ./coverage.xml
            echo "âœ… Found coverage.xml from artifact"
          elif [ -f coverage.xml ]; then
            echo "âœ… Using existing coverage.xml"
          else
            echo "âš ï¸ WARNING: coverage.xml not found - will use fallback badge" >&2
            # Create minimal valid coverage.xml (0% coverage)
            cat > coverage.xml << 'EOF'
          <?xml version="1.0" ?>
          <coverage version="5.5" timestamp="0" lines-valid="0" lines-covered="0" line-rate="0.0">
            <sources>
              <source>.</source>
            </sources>
          </coverage>
          EOF
          fi

          # Copy HTML report if available
          if [ -d coverage-data/htmlcov ]; then
            cp -r coverage-data/htmlcov/* ./htmlcov/ 2>/dev/null || true
            echo "âœ… Copied HTML coverage report"
          fi

      # Generate coverage badge with proper error handling
      - name: Generate coverage badge
        run: |
          echo "ðŸ“Š Generating coverage badge..."
          mkdir -p htmlcov

          # Validate coverage.xml exists and is readable
          if [ ! -f coverage.xml ]; then
            echo "âŒ ERROR: coverage.xml not found after preparation" >&2
            BADGE_STATUS="unknown"
          else
            # Try to generate badge (let errors show in logs)
            if genbadge coverage -i coverage.xml -o htmlcov/coverage-badge.svg; then
              echo "âœ… Coverage badge generated successfully"
              BADGE_STATUS="success"
            else
              echo "âš ï¸ WARNING: genbadge failed - see error output above" >&2
              BADGE_STATUS="error"
            fi
          fi

          # Create fallback badge if generation failed or file missing
          if [ "$BADGE_STATUS" != "success" ]; then
            echo "Creating fallback badge (status: $BADGE_STATUS)..."

            if [ "$BADGE_STATUS" = "error" ]; then
              # Generate error badge (red)
              cat > htmlcov/coverage-badge.svg << 'SVG'
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="140" height="20" role="img" aria-label="coverage: error">
            <title>coverage: error</title>
            <linearGradient id="s" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb"/>
              <stop offset="1" stop-color="#999"/>
            </linearGradient>
            <clipPath id="r">
              <rect width="140" height="20" rx="3" fill="#fff"/>
            </clipPath>
            <g clip-path="url(#r)">
              <rect width="90" height="20" fill="#555"/>
              <rect x="90" width="50" height="20" fill="#dc2626"/>
              <rect width="140" height="20" fill="url(#s)" opacity=".1"/>
            </g>
            <g fill="#fff" text-anchor="middle" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" text-rendering="geometricPrecision" font-size="110">
              <text aria-hidden="true" x="460" y="150" fill="#010101" fill-opacity=".3" transform="scale(.1)" textLength="800">coverage</text>
              <text x="460" y="140" transform="scale(.1)" fill="#fff" textLength="800">coverage</text>
              <text aria-hidden="true" x="1140" y="150" fill="#010101" fill-opacity=".3" transform="scale(.1)" textLength="400">error</text>
              <text x="1140" y="140" transform="scale(.1)" fill="#fff" textLength="400">error</text>
            </g>
          </svg>
          SVG
            else
              # Generate unknown badge (gray)
              cat > htmlcov/coverage-badge.svg << 'SVG'
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="140" height="20" role="img" aria-label="coverage: unknown">
            <title>coverage: unknown</title>
            <linearGradient id="s" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb"/>
              <stop offset="1" stop-color="#999"/>
            </linearGradient>
            <clipPath id="r">
              <rect width="140" height="20" rx="3" fill="#fff"/>
            </clipPath>
            <g clip-path="url(#r)">
              <rect width="90" height="20" fill="#555"/>
              <rect x="90" width="50" height="20" fill="#9f9f9f"/>
              <rect width="140" height="20" fill="url(#s)" opacity=".1"/>
            </g>
            <g fill="#fff" text-anchor="middle" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" text-rendering="geometricPrecision" font-size="110">
              <text aria-hidden="true" x="460" y="150" fill="#010101" fill-opacity=".3" transform="scale(.1)" textLength="800">coverage</text>
              <text x="460" y="140" transform="scale(.1)" fill="#fff" textLength="800">coverage</text>
              <text aria-hidden="true" x="1140" y="150" fill="#010101" fill-opacity=".3" transform="scale(.1)" textLength="400">unknown</text>
              <text x="1140" y="140" transform="scale(.1)" fill="#fff" textLength="400">unknown</text>
            </g>
          </svg>
          SVG
            fi
            echo "âœ… Fallback badge created"
          fi

      # Create landing page with metadata
      - name: Create landing page
        run: |
          cat > htmlcov/README.md << 'EOF'
          # ðŸ“Š ViralVibes - Test Coverage Report

          ![Coverage Badge](./coverage-badge.svg)

          **Last Updated**: $(date -u +"%Y-%m-%d %H:%M UTC")

          **CI Workflow Run**: [${{ github.event.workflow_run.id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})

          ---

          ## ðŸ“ˆ View Full Report

          [ðŸ“Š Click here for detailed HTML coverage report â†’](./index.html)

          ## ðŸ”— Quick Links

          - [ðŸ  Repository](https://github.com/${{ github.repository }})
          - [ðŸ”„ CI Workflows](https://github.com/${{ github.repository }}/actions)
          - [ðŸ“‹ Latest CI Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})

          ---

          *Generated by GitHub Actions â€¢ [View Workflow](https://github.com/${{ github.repository }}/actions/workflows/coverage-badge.yml)*
          EOF

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./htmlcov
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸ“Š Coverage report updated'

      # Final status
      - name: Workflow Summary
        if: always()
        run: |
          echo "## Coverage Badge Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Badge generated and deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage Report**: https://github.com/${{ github.repository }}/deployments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pages URL**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/htmlcov/" >> $GITHUB_STEP_SUMMARY
