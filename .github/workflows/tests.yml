name: Run Tests (reusable)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: '3.10'
      coverage-threshold:
        required: false
        type: number
        default: 80
    secrets:
      NEXT_PUBLIC_SUPABASE_URL:
        required: false
      NEXT_PUBLIC_SUPABASE_ANON_KEY:
        required: false
      YOUTUBE_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      TESTING: "1"
      # ‚úÖ Force Python to skip .pyc cache
      PYTHONDONTWRITEBYTECODE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          # ‚úÖ Disable pip cache to force fresh install
          cache: 'pip'
          cache-dependency-path: '**/requirements*.txt'

      - name: Clear all caches
        run: |
          pip cache purge || true
          find /opt/hostedtoolcache/Python -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
          find /opt/hostedtoolcache/Python -type f -name "*.pyc" -delete 2>/dev/null || true

          echo "‚úÖ All caches cleared"

      - name: Verify Python version
        run: |
          PYTHON_VERSION=$(python --version | grep -oP '\d+\.\d+\.\d+')
          echo "üêç Python version: $PYTHON_VERSION"

          if ! python -c "import sys; sys.exit(0 if sys.version_info >= (3, 10, 0) else 1)"; then
            echo "‚ùå ERROR: Python 3.10+ required, but $PYTHON_VERSION is installed"
            exit 1
          fi

          echo "‚úÖ Python version verified: $PYTHON_VERSION"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          echo "üì¶ Installing dependencies..."
          if [ -f requirements-backend.txt ]; then
            pip install --no-cache-dir -r requirements-backend.txt
          else
            pip install --no-cache-dir pytest pytest-asyncio httpx starlette
          fi

          # ‚úÖ STEP 3: Install testing dependencies
          pip install --no-cache-dir pytest-cov coverage[toml] packaging

          echo "‚úÖ All dependencies installed"

      - name: Patch fastcore SyntaxError
        run: |
          echo "üîß Patching fastcore docments.py SyntaxError..."

          FASTCORE_PATH=$(python -c "import fastcore, os; print(os.path.dirname(fastcore.__file__))")
          DOCMENTS_FILE="$FASTCORE_PATH/docments.py"

          echo "üìù File to patch: $DOCMENTS_FILE"

          # Backup original
          cp "$DOCMENTS_FILE" "$DOCMENTS_FILE.bak"

          # Apply patch using Python (pass filename as argument)
          python - "$DOCMENTS_FILE" << 'PATCHEOF'
          import sys

          file_path = sys.argv[1]

          with open(file_path, 'r') as f:
              lines = f.readlines()

          # Line 359 (index 358) - fix f-string with backslash
          if len(lines) > 358:
              old_line = lines[358]
              # Replace: f"def {get_name(self.obj)}(\n    {'\n    '.join(lines)}\n{self._ret_str}"
              # With:    f"def {get_name(self.obj)}(\n    " + '\n    '.join(lines) + f"\n{self._ret_str}"
              new_line = '            sig_str = f"def {get_name(self.obj)}(\\n    " + \'\\n    \'.join(lines) + f"\\n{self._ret_str}"\n'
              lines[358] = new_line

              with open(file_path, 'w') as f:
                  f.writelines(lines)

              print(f"‚úÖ Patched line 359")
              print(f"   Old: {old_line.strip()}")
              print(f"   New: {new_line.strip()}")
          else:
              print(f"‚ùå File too short, line 359 not found")
              sys.exit(1)
          PATCHEOF

          echo "‚úÖ Fastcore patched successfully"

      - name: Verify fastcore installation
        run: |
          # Show installed version
          FASTCORE_VERSION=$(pip show fastcore | grep Version | cut -d' ' -f2)
          echo "üì¶ fastcore version: $FASTCORE_VERSION (patched)"

          # Show installation path
          FASTCORE_PATH=$(python -c "import fastcore; print(fastcore.__file__)")
          echo "üìÅ fastcore path: $FASTCORE_PATH"

          python -c "
          from packaging import version
          import sys
          v = version.parse('$FASTCORE_VERSION')
          if v < version.parse('1.10.0'):
              print('‚ùå fastcore version too old: $FASTCORE_VERSION')
              sys.exit(1)
          print('‚úÖ fastcore version OK: $FASTCORE_VERSION (patched)')
          "

      - name: Test critical imports
        run: |
          python -B -c "
          import sys
          sys.dont_write_bytecode = True
          try:
              from fastcore.all import *
              print('‚úÖ fastcore.all imports successfully (after patch)')
          except Exception as e:
              print(f'‚ùå fastcore.all import failed: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

          # ‚úÖ Test monsterui import
          python -B -c "
          import sys
          sys.dont_write_bytecode = True
          try:
              from monsterui.all import *
              print('‚úÖ monsterui imports successfully')
          except Exception as e:
              print(f'‚ùå monsterui import failed: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

      - name: Prepare reports directory
        run: mkdir -p reports htmlcov

      - name: Run tests with coverage
        run: |
          python -B -m coverage run -m pytest tests/ -vv -s \
            --log-cli-level=INFO \
            --junitxml=reports/junit.xml
        continue-on-error: false

      - name: Generate coverage reports
        if: always()
        run: |
          coverage xml
          coverage json
          coverage html
          echo "‚úÖ Coverage reports generated"

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            coverage.json
            htmlcov/
          retention-days: 7

      - name: Upload JUnit XML artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-junit-py3.10
          path: reports/junit.xml
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/junit.xml
          check_name: Test Results (Python 3.10)
          comment_mode: off

      - name: Coverage summary
        if: always()
        run: |
          echo "### Coverage Report üìä" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/coverage.md ]; then
            cat reports/coverage.md >> $GITHUB_STEP_SUMMARY
          else
            coverage report --format=markdown >> $GITHUB_STEP_SUMMARY
          fi
