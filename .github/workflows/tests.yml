name: Run Tests (reusable)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: '3.11.6'
      coverage-threshold:
        required: false
        type: number
        default: 80
    secrets:
      NEXT_PUBLIC_SUPABASE_URL:
        required: false
      NEXT_PUBLIC_SUPABASE_ANON_KEY:
        required: false
      YOUTUBE_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      TESTING: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11.6
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.6"
          cache: 'pip'
          cache-dependency-path: '**/requirements*.txt'

      - name: Clear pip cache (force fresh install)
        run: |
          pip cache purge
          echo "âœ… Pip cache cleared"

      - name: Verify Python version
        run: |
          PYTHON_VERSION=$(python --version | grep -oP '\d+\.\d+\.\d+')
          echo "ðŸ Python version: $PYTHON_VERSION"

          if ! python -c "import sys; sys.exit(0 if sys.version_info >= (3, 11, 6) else 1)"; then
            echo "âŒ ERROR: Python 3.11.6+ required, but $PYTHON_VERSION is installed"
            exit 1
          fi

          echo "âœ… Python version verified: $PYTHON_VERSION"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          # Install backend dependencies if they exist
          if [ -f requirements-backend.txt ]; then
            pip install -r requirements-backend.txt
          else
            pip install pytest pytest-asyncio httpx starlette
          fi

          # Always install testing dependencies
          pip install pytest-cov coverage[toml]

          echo "âœ… Dependencies installed"

      - name: Prepare reports directory
        run: mkdir -p reports htmlcov

      - name: Run tests with coverage
        run: |
          coverage run -m pytest tests/ -vv -s \
            --log-cli-level=INFO \
            --junitxml=reports/junit.xml
        continue-on-error: false

      - name: Generate coverage reports
        if: always()
        run: |
          coverage xml
          coverage json
          coverage html
          echo "âœ… Coverage reports generated"

      # âœ… Make sure this uploads coverage.xml and htmlcov/
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            coverage.json
            htmlcov/
          retention-days: 7

      - name: Upload JUnit XML artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-junit-py3.11.6
          path: reports/junit.xml
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/junit.xml
          check_name: Test Results (Python 3.11.6)
          comment_mode: off

      - name: Coverage summary
        if: always()
        run: |
          echo "### Coverage Report ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/coverage.md ]; then
            cat reports/coverage.md >> $GITHUB_STEP_SUMMARY
          else
            coverage report --format=markdown >> $GITHUB_STEP_SUMMARY
          fi
