name: Run Tests (reusable)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: '3.11'
      coverage-threshold:
        required: false
        type: number
        default: 80
    secrets:
      NEXT_PUBLIC_SUPABASE_URL:
        required: false
      NEXT_PUBLIC_SUPABASE_ANON_KEY:
        required: false
      YOUTUBE_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better coverage diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'  # Built-in pip caching (simpler than manual cache)
          cache-dependency-path: '**/requirements*.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-backend.txt ]; then
            pip install -r requirements-backend.txt
          else
            pip install pytest pytest-asyncio httpx starlette
          fi
          pip install pytest-cov coverage[toml]

      - name: Prepare reports dir
        run: mkdir -p reports htmlcov

      - name: Run tests with coverage
        run: |
          coverage run -m pytest tests/ -vv -s \
            --log-cli-level=INFO \
            --junitxml=reports/junit.xml
        continue-on-error: false

      # Generate all coverage reports after test run
      - name: Generate coverage reports
        if: always()
        run: |
          coverage xml
          coverage json
          coverage html

      # âœ… Make sure this uploads coverage.xml and htmlcov/
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            coverage.json
            htmlcov/
          retention-days: 7  # Short retention, only needed for badge workflow

      - name: Upload JUnit XML artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-junit-py${{ inputs.python-version }}
          path: reports/junit.xml
          retention-days: 30

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: reports/junit.xml
          check_name: Test Results (Python ${{ inputs.python-version }})
          comment_mode: off

      - name: Coverage summary
        if: always()
        run: |
          echo "### Coverage Report ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat reports/coverage.md >> $GITHUB_STEP_SUMMARY || coverage report --format=markdown >> $GITHUB_STEP_SUMMARY
