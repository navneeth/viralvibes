name: Run Tests (reusable)

on:
  workflow_call:
    inputs:
      python-version:
        required: false
        type: string
        default: '3.10'
      coverage-threshold:
        required: false
        type: number
        default: 80
    secrets:
      NEXT_PUBLIC_SUPABASE_URL:
        required: false
      NEXT_PUBLIC_SUPABASE_ANON_KEY:
        required: false
      YOUTUBE_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

jobs:
  run-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      TESTING: "1"
      # âœ… Force Python to skip .pyc cache
      PYTHONDONTWRITEBYTECODE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'  # âœ… Re-enable cache

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-backend.txt
          pip install pytest-cov coverage[toml] packaging

      - name: Prepare reports directory
        run: mkdir -p reports htmlcov

      - name: Run tests with coverage
        run: |
          python -B -m coverage run -m pytest tests/ -vv -s \
            --log-cli-level=INFO \
            --junitxml=reports/junit.xml
        continue-on-error: false

      - name: Generate coverage reports
        if: always()
        run: |
          coverage xml
          coverage json
          coverage html
          echo "âœ… Coverage reports generated"

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            coverage.xml
            coverage.json
            htmlcov/
          retention-days: 7

      - name: Upload JUnit XML artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: pytest-junit-py3.10
          path: reports/junit.xml
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/junit.xml
          check_name: Test Results (Python 3.10)
          comment_mode: off

      - name: Coverage summary
        if: always()
        run: |
          echo "### Coverage Report ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/coverage.md ]; then
            cat reports/coverage.md >> $GITHUB_STEP_SUMMARY
          else
            coverage report --format=markdown >> $GITHUB_STEP_SUMMARY
          fi
